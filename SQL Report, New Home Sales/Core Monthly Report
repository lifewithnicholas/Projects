WITH params AS (
  SELECT 
    DATE '2000-01-01' AS start_date,
    DATE '2015-12-31' AS end_date
),
-- 1) New-home sales in window
sales_in_window AS (
  SELECT s.*
  FROM sales s
  JOIN params p ON s.sale_date BETWEEN p.start_date AND p.end_date
  WHERE s.is_new_home = TRUE
),
-- 2) Monthly bucket for sales
sales_monthly AS (
  SELECT
    DATE_TRUNC('month', sale_date)::date AS month_start,
    COUNT(*)                         AS sales_count,
    COUNT(DISTINCT user_id)          AS distinct_buyers,
    AVG(sale_price)::numeric(12,2)   AS avg_sale_price,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY sale_price)
      ::numeric(12,2)                AS median_sale_price,
    SUM(sale_price)::numeric(14,2)   AS total_sales_volume,
    AVG( (loan_amount::numeric) / NULLIF(sale_price,0) )
      ::numeric(6,4)                 AS avg_ltv,
    ARRAY_AGG(DISTINCT lender)       AS lenders_in_month
  FROM sales_in_window
  GROUP BY 1
),
-- 3) Monthly mortgage rate (average of daily/weekly points)
rates_monthly AS (
  SELECT
    DATE_TRUNC('month', rate_date)::date AS month_start,
    AVG(avg_30yr_fixed)::numeric(5,3)   AS avg_30yr_fixed_rate
  FROM interest_rates
  GROUP BY 1
),
-- 4) Join sales to rates
report AS (
  SELECT
    s.month_start,
    s.sales_count,
    s.distinct_buyers,
    s.avg_sale_price,
    s.median_sale_price,
    s.total_sales_volume,
    s.avg_ltv,
    r.avg_30yr_fixed_rate
  FROM sales_monthly s
  LEFT JOIN rates_monthly r USING (month_start)
  ORDER BY s.month_start
)
SELECT * FROM report;
